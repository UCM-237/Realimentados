\chapter{Control por realimentaci√≥n de estados}

\section{Guideline to design a linear controller for the inverted pendulum}
1. \\ \\
Given the model $\Sigma$ of a dynamical system
\begin{equation}
	\Sigma := \begin{cases}
		\dot x(t) =& f(x(t),u(t)) \\ y(t) =& g(x(t),u(t))
	\end{cases}, \nonumber
\end{equation}
choose an operational/equilibrium point $x^*$ of interest. \\

\textcolor{blue}{For the pendulum, let us choose when it is in vertical position and at rest, i.e., $\theta^* = 0$, $\dot\theta^* = 0$. So you we have that $x^* = \begin{bmatrix}0 \\ 0\end{bmatrix}$.} \\

2. \\ \\
Since $x^*$ is an equilibrium, find out which $u^*$ makes $\dot x(t) = 0$, i.e., $f(x^*,u^*) = 0$. \\
\textcolor{blue}{We have that $u = T$, and that $\ddot\theta = \frac{1}{ml^2}\left(mgl\sin\theta - b\dot\theta + T\right)$. To keep $x^*$ fixed, we need to set $\ddot\theta = 0$, therefore $u^* = T^* = 0$. Note that for another $x^*$, we would have different $T^*$.} \\

3. \\ \\
Now we want the system around $x^*$ and $u^*$ to be an stable equilibrium, i.e., for a small deviation/disturbance $\delta x$, we need to calculate the necessary $\delta u$ to keep the system at $x^*$.

We calculate the dynamics of $\delta x$ and $\delta u$, i.e., we linearize $\Sigma$ around $x^*$ and $u^*$.
\begin{equation}
	\Sigma := \begin{cases}
		\dot x(t) =& f(x(t),u(t)) \\ y(t) =& g(x(t),u(t))
	\end{cases} \approx
	\begin{cases}
		\dot {\delta x(t)} &= A(t) \delta x(t) + B(t) \delta u(t) \\
		\dot {\delta y(t)} &= C(t) \delta x(t) + D(t) \delta u(t)
	\end{cases} \quad \text{if } x\approx x^* + \delta x, u\approx u^* + \delta u, \nonumber
\end{equation}
where the matrices $A(t), B(t), C(t)$ and $D(t)$ are the Jacobians from Week 14. Note that it is usual to set the origin of the coordinates $x$ the system at $x^*$, this is why you will find in many places (including Week 14) $\delta x = x$ for the linearized version of $\Sigma$. \\
\textcolor{blue}{The Jacobians for the inverted pendulum are
\begin{align}
	A &= \begin{bmatrix}0 & 1 \\ \frac{1}{ml^2}(mgl\cos\theta) & -\frac{b}{ml^2} \end{bmatrix} \nonumber \\
		B &= \begin{bmatrix}0 \\ 1 \end{bmatrix} \nonumber \\
		C &= \begin{bmatrix}1 & 0 \\ 0 & 1\end{bmatrix} \nonumber \\
		D &= \begin{bmatrix}0 \\ 0 \end{bmatrix}.
\end{align}
Note that $A$ has to be evaluated at $x^*$ (check the notes from Week 14). Therefore, for $\theta = 0$, we have that $A = \begin{bmatrix}0 & 1 \\ \frac{g}{l} & -\frac{b}{ml^2} \end{bmatrix}$.} We assume that $C = I$, i.e., we can measure all the elements from the state vector $x$.\\

4. \\ \\

Let us calculate the linear controller 
\begin{equation}
	\delta u = K\delta y, \label{eq: con}
\end{equation}
such that $x^*$ is stable. We substitute (\ref{eq: con}) in the linearized $\Sigma$ resulting in
\begin{align}
\dot {\delta x(t)} &= A(t) \delta x(t) + B(t) K\delta y \nonumber \\
	&= A(t) \delta x(t) + B(t) K C(t) \delta x(t) + K D(t) \delta u(t) \nonumber \\
	&= \left(A(t) + B(t) K C(t)\right) x(t) + K D(t) u(t) \label{eq: system2}
\end{align}
Consider that $D(t) = 0$, and $A(t)$ and $B(t)$ are constant matrices, i.e., their elements do not depend on time. Then, we can write (\ref{eq: system2}) as
\begin{align}
\dot{\delta x(t)} &= \left(A + BKC\right) x(t) \\
	&= M x(t). \label{eq: system}
\end{align}
Then, the linearized system $\Sigma$ is stable around $x^*$ under small disturbances if and only if $M$ has all its eigenvalues with negative real part (Week 15).
\textcolor{blue}{
	To have the addition $A+BKC$, we need $K$ with the appropriate dimensions. For $C = I$ we have that $K = \begin{bmatrix}k_{11} & k_{12}\end{bmatrix}$, so we have that
\begin{equation}
	M = A + KBC = \begin{bmatrix}0 & 1 \\ \frac{g}{l}+\frac{k_{11}}{ml^2} & -\frac{b}{ml^2}+\frac{k_{12}}{ml^2}\end{bmatrix} \label{eq: Mp}
\end{equation}
}


5. \\ \\

A matrix $M\in\mathbb{R}^{n\times n}$ has $n$ eigenvalues. The eigenvalues of $M$ can be calculated from the following determinant
\begin{equation}
	\operatorname{det}\{M - \lambda_{i} I\} = 0, \quad i\in\{1,\dots,n\}. \label{eq: det}
\end{equation}
For example, for a $2 \times 2$ matrix we have that $\operatorname{det}\{A\} = \begin{bmatrix}a_{11} & a_{12} \\ a_{21} & a_{22}\end{bmatrix} = a_{11}a_{22} - a_{12}a_{21}$. Therefore we have that (\ref{eq: det}) is
\begin{equation}
	(m_{11} - \lambda_i) (m_{22} - \lambda_i) - m_{12}m_{21} = 0, \quad  i\in\{1,2\}. \label{eq: con2}
\end{equation}
The values for the elements of $K$ are calculated by setting an arbitrary $\lambda_i < 0$. This solution is guaranteed for $C = I$ and $D = 0$. \\
\textcolor{blue}{
	We have that (\ref{eq: con2}) from $M$ in (\ref{eq: Mp}) is
\begin{equation}
	\lambda^2 + \lambda\left(\frac{1}{ml^2}(b-k_{12})\right) - \frac{g}{l}-\frac{k_{11}}{ml^2}, \nonumber
\end{equation}
whose solution is given by
\begin{equation}
	\lambda_{1,2} = \frac{-\frac{1}{ml^2}(b-k_{12}) \pm \sqrt{\frac{(b-k_{12})^2}{m^2l^4}+4(\frac{g}{l}+\frac{k_{11}}{ml^2})}}{2}. \label{eq: lc}
\end{equation}
Let us find some conditions for $k_{11}$ and $k_{12}$ such that we can guarantee that $\lambda_1$ and $\lambda_2$ are two real negative numbers. For example, if force
\begin{equation}
	k_{12} < b,
\end{equation}
then $-\frac{1}{ml^2}(b-k_{12})$ in (\ref{eq: lc}) is a negative number. Note that $b$ is a coefficient friction in the pendulum equation, therefore if $b = 1$, we can have $-\infty < k_{12} < 1$, i.e., the gain $k_{12}$ can be even positive as long as it is smaller than $b$. Now we turn our attention at the square root in (\ref{eq: lc}). Assume that we take the positive solution $r>0$ of the square root in (\ref{eq: lc}). Now we need to add or subtract $r$ to $-\frac{1}{ml^2}(b-k_{12})$. We note that for $\lambda_1$ if $-\frac{1}{ml^2}(b-k_{12})$ is negative then $-\frac{1}{ml^2}(b-k_{12})- r$ is still negative, so $\lambda_1 < 0$. For $\lambda_2$ we need to calculate $k_{11}$ such that  $-\frac{1}{ml^2}(b-k_{12}) + r < 0$. If we set $k_{11} < -gml$ then $\sqrt{\frac{(b-k_{12})^2}{m^2l^4}+4(\frac{g}{l}+\frac{k_{11}}{ml^2})} < \sqrt{\frac{(b-k_{12})^2}{m^2l^4}} = \frac{1}{ml^2}(b-k_{12})$. Therefore we guarantee that $r < \frac{1}{ml^2}(b-k_{12})$, thus $\lambda_2 < 0$. Note that $k_{11}$ not only needs to be negative but \emph{negative enough}. Check in the Python script the consequences of playing around these limits for $k_{11}$ and $k_{12}$.
}

\section{Controller for the inverted pendulum}
Design a controller for
\begin{align}
	x_1^* = \begin{cases}\theta^* &= 0 \\ \dot\theta^*&= 0 \end{cases} \nonumber \\
		x_2^* = \begin{cases}\theta^* &= \frac{\pi}{4} \\ \dot\theta^*&= 0 \end{cases}. \nonumber
\end{align}
We will first assume that we can measure $\theta$ and $\dot\theta$, i.e., $C = I$. Note that for $M = (A - BKC)$ with $C = I$ the dimensions of $K$ must be $1 \times 2$, i.e., $K = \begin{bmatrix}k_{11} & k_{12} \end{bmatrix}$. Note that in this case we have that $K\delta y = k_{11}\delta\theta + k_{12}\delta\dot\theta$. Remember that the input $u = u^* + \delta u$, and that for the pendulum $u = T$, i.e., the applied torque.

\textbf{The exercise asks to find the values $k_{11}$ and $k_{12}$ for two arbitrary negative real eigenvalues $\lambda_1$ and $\lambda_2$ in (\ref{eq: con2}).}

Simulate your designed controller in the Python script. Check that your $x^*$ are stable if you start close to them, and you can further check the robustness by applying small disturbances, e.g., add a small random number to $x$ at every iteration.

Is it possible to design a stable controller with $C = \begin{bmatrix}1 & 0\end{bmatrix}$? and for $C = \begin{bmatrix}0 & 1\end{bmatrix}$? Note that for this cases $K$ will have different dimensions than for $C = I$ since $C$ has different dimensions as well.
